---
import ConcursoCard from './ConcursoCard.astro';
import { concursosData } from '../data/concursosData';

// Configuración del slider de cards
const totalCards = concursosData.length;
const visibleCards = 3; // Cards visibles a la vez en desktop
---

<section id="concursos" class="bg-brand-backgroundGlobal h-auto w-auto">
  <div class="general bg-accent-cyan relative z-30 min-h-128 pb-12">
    <!-- Título -->
    <h1 class="heading-impact pt-16 pl-6 sm:pt-20 sm:pl-10">
      Concursos <br /> Activos
    </h1>

    <!-- Slider container -->
    <div class="concursos-slider-wrapper">
      <div class="concursos-navigation">
        <!-- Previous button -->
        <button
          id="prevBtnConcursos"
          type="button"
          class="nav-btn-concursos nav-btn-prev"
          aria-label="Concursos anteriores"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2.5"
            stroke="currentColor"
            class="nav-arrow-concursos"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 19.5 8.25 12l7.5-7.5"></path>
          </svg>
        </button>

        <!-- Cards viewport -->
        <div class="cards-viewport-concursos">
          <div
            id="cardSliderConcursos"
            class="cards-track-concursos"
            role="list"
            aria-label="Lista de concursos activos"
          >
            {
              concursosData.map((concurso) => (
                <div class="card-item-concursos" role="listitem">
                  <ConcursoCard
                    title={concurso.title}
                    date={concurso.date}
                    imageUrl={concurso.imageUrl}
                    altText={concurso.altText}
                    ctaLink={concurso.ctaLink}
                    ctaText={concurso.ctaText}
                  />
                </div>
              ))
            }
          </div>
        </div>

        <!-- Next button -->
        <button
          id="nextBtnConcursos"
          type="button"
          class="nav-btn-concursos nav-btn-next"
          aria-label="Concursos siguientes"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2.5"
            stroke="currentColor"
            class="nav-arrow-concursos"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m8.25 4.5 7.5 7.5-7.5 7.5"></path>
          </svg>
        </button>
      </div>

      <!-- Pagination dots -->
      <div class="pagination-dots-concursos" id="paginationConcursos">
        <!-- Dots will be generated by JS -->
      </div>
    </div>
  </div>
</section>

<script define:vars={{ totalCards, visibleCards }}>
  function initConcursosSlider() {
    const prevBtn = document.getElementById('prevBtnConcursos');
    const nextBtn = document.getElementById('nextBtnConcursos');
    const slider = document.getElementById('cardSliderConcursos');
    const viewport = document.querySelector('.cards-viewport-concursos');
    const pagination = document.getElementById('paginationConcursos');

    if (!prevBtn || !nextBtn || !slider || !pagination || !viewport) return;

    let currentIndex = 0;
    let cardsPerPage = 3;
    let itemWidth = 0;
    let gap = 0;

    function calculateLayout() {
      const firstItem = slider.querySelector('.card-item-concursos');
      if (!firstItem) return;

      const viewportWidth = window.innerWidth;

      if (viewportWidth < 640) {
        cardsPerPage = 1;
      } else if (viewportWidth < 1024) {
        cardsPerPage = 2;
      } else {
        cardsPerPage = 3;
      }

      // Medir el ancho real del item renderizado
      itemWidth = firstItem.offsetWidth;

      // Obtener el gap real del CSS
      const computedStyle = window.getComputedStyle(slider);
      gap = parseFloat(computedStyle.gap) || 0;

      // Ajustar el ancho del viewport para que quepan exactamente las tarjetas indicadas
      const requiredViewportWidth =
        itemWidth * cardsPerPage + gap * (cardsPerPage - 1);
      viewport.style.maxWidth = `${requiredViewportWidth}px`;
    }

    function getMaxIndex() {
      return Math.max(0, Math.ceil(totalCards / cardsPerPage) - 1);
    }

    function generateDots() {
      pagination.innerHTML = '';
      const numPages = getMaxIndex() + 1;
      for (let i = 0; i < numPages; i++) {
        const dot = document.createElement('button');
        dot.className = `pagination-dot ${i === currentIndex ? 'active' : ''}`;
        dot.setAttribute('aria-label', `Ir a página ${i + 1}`);
        dot.addEventListener('click', () => {
          currentIndex = i;
          updateSlider();
        });
        pagination.appendChild(dot);
      }
    }

    function updateSlider() {
      const maxIndex = getMaxIndex();
      if (currentIndex > maxIndex) currentIndex = maxIndex;

      const offset = -currentIndex * cardsPerPage * (itemWidth + gap);
      slider.style.transform = `translateX(${offset}px)`;

      // Update button states
      prevBtn.disabled = currentIndex <= 0;
      nextBtn.disabled = currentIndex >= maxIndex;
      prevBtn.style.opacity = currentIndex <= 0 ? '0.4' : '1';
      nextBtn.style.opacity = currentIndex >= maxIndex ? '0.4' : '1';

      // Update dots
      const dots = pagination.querySelectorAll('.pagination-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }

    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateSlider();
      }
    });

    nextBtn.addEventListener('click', () => {
      const maxIndex = getMaxIndex();
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateSlider();
      }
    });

    // Recalculate on resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        calculateLayout();
        currentIndex = 0;
        generateDots();
        updateSlider();
      }, 150);
    });

    // Esperar a que las fuentes y estilos se apliquen
    setTimeout(() => {
      calculateLayout();
      generateDots();
      updateSlider();
    }, 100);
  }

  document.addEventListener('DOMContentLoaded', initConcursosSlider);
</script>

<style>
  .general {
    clip-path: polygon(0 11%, 100% 0%, 100% 100%, 0 100%);
    background-image: url('../assets/concursosBackgraund.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }

  .heading-impact {
    color: var(--color-text-dark);
    text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
    font-weight: bold;
    display: inline-block;
    transform: scaleX(1.1);
    transform-origin: left;
  }

  .concursos-slider-wrapper {
    width: 100%;
    padding: 1.5rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .concursos-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    width: 100%;
    max-width: 1200px;
  }

  .cards-viewport-concursos {
    flex: 1;
    overflow: hidden;
    max-width: 100%;
  }

  .cards-track-concursos {
    display: flex;
    gap: 1.5rem;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-item-concursos {
    flex-shrink: 0;
  }

  /* Navigation buttons */
  .nav-btn-concursos {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 0.5rem;
    background: var(--palette-brand-dark, #011822);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .nav-btn-concursos:hover:not(:disabled) {
    background: var(--palette-accent-orange, #f49624);
    transform: scale(1.1);
  }

  .nav-btn-concursos:disabled {
    cursor: not-allowed;
  }

  .nav-arrow-concursos {
    width: 1.25rem;
    height: 1.25rem;
    stroke: var(--palette-accent-orange, #f49624);
    transition: stroke 0.3s ease;
  }

  .nav-btn-concursos:hover:not(:disabled) .nav-arrow-concursos {
    stroke: var(--palette-brand-dark, #011822);
  }

  /* Pagination dots */
  .pagination-dots-concursos {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .pagination-dots-concursos :global(.pagination-dot) {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: none;
    background: var(--palette-brand-dark, #011822);
    opacity: 0.4;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  .pagination-dots-concursos :global(.pagination-dot:hover) {
    opacity: 0.7;
    transform: scale(1.2);
  }

  .pagination-dots-concursos :global(.pagination-dot.active) {
    background: var(--palette-accent-orange, #f49624);
    opacity: 1;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .concursos-navigation {
      gap: 0.5rem;
    }
    .nav-btn-concursos {
      min-width: 36px;
      min-height: 36px;
    }
    .cards-track-concursos {
      gap: 1rem;
    }
  }
</style>
