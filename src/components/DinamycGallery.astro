---
/**
 * DinamycGallery Component
 *
 * Main gallery with category switching and slider navigation.
 * Renders items dynamically from local data arrays — no API calls.
 *
 * Each category's items are rendered through the appropriate card
 * component determined by the item's `type` discriminant.
 */

// Import data
import { arteGallery, fotografiaGallery, musicaGallery } from "../data";
import type { CategoryConfig } from "../data/types";

// Import UI components
import CategoryButton from "./gallery/CategoryButton.astro";
import FotografiaCard from "./gallery/FotografiaCard.astro";
import GalleryItemCard from "./gallery/GalleryItem.astro";
import MusicCard from "./gallery/MusicCard.astro";
import NavigationButton from "./gallery/NavigationButton.astro";

// Gallery categories — single source of truth
const categories: readonly CategoryConfig[] = [
  { id: "arte", label: "Arte", items: arteGallery },
  { id: "musica", label: "Música", items: musicaGallery },
  { id: "fotografia", label: "Fotografía", items: fotografiaGallery },
] as const;
---

<section id="galeria" class="gallery-section">
  <!-- Ensure shared animation variables are loaded so JS can read them -->
  <link rel="stylesheet" href="/src/styles/animations.css" />

  <!-- Category buttons -->
  <div class="category-controls" data-category-buttons>
    {
      categories.map((category, index) => (
        <CategoryButton category={category.id} label={category.label} isActive={index === 0} />
      ))
    }
  </div>

  <!-- Gallery container with responsive wrapper -->
  <div class="gallery-outer-wrapper">
    <div class="gallery-inner-container">
      <!-- Previous button -->
      <NavigationButton id="prevBtn" direction="prev" ariaLabel="Previous gallery page" />

      <!-- Gallery slider -->
      <div class="gallery-container">
        <div class="gallery-viewport">
          <div id="imageSlider" class="gallery-track">
            {
              categories.flatMap((category) =>
                category.items.map((item) => {
                  switch (item.type) {
                    case "arte":
                      return <GalleryItemCard item={item} />;
                    case "musica":
                      return <MusicCard item={item} />;
                    case "fotografia":
                      return <FotografiaCard item={item} />;
                  }
                })
              )
            }
          </div>
        </div>
      </div>

      <!-- Next button -->
      <NavigationButton id="nextBtn" direction="next" ariaLabel="Next gallery page" />
    </div>

    <!-- Behaviour is initialized from a centralized client initializer -->
    <!-- Add to the page that uses this component: -->
    <!-- <script type="module" src="/src/client/initializers/galeria.ts"></script> -->

    <style>
      /*
       * ─── DESIGN TOKENS ──────────────────────────────────────────────
       * Single source of truth for values used across multiple rules.
       * Change here → propagates everywhere automatically.
       * --shadow-bleed : how far the yellow ::before card shadow escapes
       *                  outside the card boundary (must match GalleryItem)
       * --nav-w        : width each nav button occupies in the flex row
       *                  (mobile/tablet: relative; desktop: absolute -50px)
       */
      .gallery-section {
        --shadow-bleed: 0.4rem;
        --nav-w: 56px; /* matches rendered size of nav-btn (p-3 + icon 24px) */
      }

      /* ─── SECTION ───────────────────────────────────────────────────── */
      .gallery-section {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80dvh;
        width: 100%;
        background: #030712;
        /*
         * overflow-x: clip  → hides the slider track that extends beyond
         *                      the section while NOT creating a scroll
         *                      container (unlike overflow:hidden), so
         *                      position:absolute children still work.
         * overflow-y: visible → lets the ::before yellow shadow paint
         *                       below the last card row without clipping.
         */
        overflow-x: clip;
        overflow-y: visible;
        padding: 4rem 1rem calc(4rem + var(--shadow-bleed));
      }

      /* ─── CATEGORY CONTROLS ─────────────────────────────────────────── */
      .category-controls {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 20;
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        flex-wrap: wrap;
      }

      /* ─── OUTER WRAPPER ─────────────────────────────────────────────── */
      .gallery-outer-wrapper {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 3rem;
      }

      /* ─── INNER CONTAINER (flex row: [prev] [gallery] [next]) ───────── */
      .gallery-inner-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        /*
         * Reserve --shadow-bleed on the right so the rightmost card's
         * ::before never gets clipped by the section's overflow-x:clip.
         * This is the single padding that fixes the right-side shadow on
         * ALL breakpoints — no need to tweak every max-width individually.
         */
        padding-right: var(--shadow-bleed);
        max-width: calc(100vw - 2rem);
      }

      /* ─── GALLERY CONTAINER ─────────────────────────────────────────── */
      /*
       * overflow: visible — the track must slide freely; clipping is
       * handled by the section's overflow-x: clip above, not here.
       */
      .gallery-container {
        position: relative;
        overflow: visible;
        flex: 1;
        min-width: 0; /* prevent flex child from overflowing its parent */
      }

      /* ─── GALLERY VIEWPORT ──────────────────────────────────────────── */
      /*
       * overflow: visible — cards and their ::before shadows must escape.
       * padding-bottom    — space for the ::before bottom shadow offset.
       * No padding-right needed here: handled by inner-container above.
       */
      .gallery-viewport {
        overflow: visible;
        position: relative;
        padding-bottom: var(--shadow-bleed);
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .gallery-viewport::-webkit-scrollbar {
        display: none;
      }

      /* ─── GALLERY TRACK ─────────────────────────────────────────────── */
      .gallery-track {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }

      /* ─── RESPONSIVE ────────────────────────────────────────────────── */

      /* Mobile — 1 card (≤ 640px) */
      @media (max-width: 640px) {
        .gallery-section {
          min-height: 70dvh;
          padding: 2rem 0.5rem calc(2rem + var(--shadow-bleed));
        }

        .category-controls {
          padding: 1rem;
          gap: 0.5rem;
        }

        .gallery-inner-container {
          gap: 0.25rem;
        }
      }

      /* Small tablets — 2 cards (641px – 768px) */
      @media (min-width: 641px) and (max-width: 768px) {
        .gallery-section {
          padding: 3rem 1rem calc(3rem + var(--shadow-bleed));
        }
      }

      /* Tablets — 3 cards (769px – 1023px) */
      @media (min-width: 769px) and (max-width: 1023px) {
        .gallery-inner-container {
          max-width: min(960px, calc(100vw - 2rem));
        }
      }

      /* Desktop — 4 cards (≥ 1024px) */
      @media (min-width: 1024px) {
        .gallery-inner-container {
          max-width: 1280px;
        }

        /*
         * Lock the container to exactly 4-card width so the track never
         * shows a 5th partial card.  +shadow-bleed keeps the rightmost
         * card's ::before visible without expanding the layout.
         */
        .gallery-container {
          flex: none;
          width: calc(4 * 285px + 3 * 1rem + var(--shadow-bleed));
        }
      }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .gallery-track {
          transition: none;
        }
      }
    </style>
  </div>
</section>
