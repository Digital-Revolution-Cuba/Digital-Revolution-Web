---
/**
 * DinamycGallery Component
 * Main gallery component with category switching and slider navigation
 * Refactored for maintainability and clean architecture
 */

// Import data
import { arteGallery, musicaGallery, fotografiaGallery } from '../data';
import type { CategoryConfig } from '../data/types';

// Import UI components
import GalleryItem from './gallery/GalleryItem.astro';
import MusicCard from './gallery/MusicCard.astro';
import FotografiaCard from './gallery/FotografiaCard.astro';
import CategoryButton from './gallery/CategoryButton.astro';
import NavigationButton from './gallery/NavigationButton.astro';

// Import configuration
import { GALLERY_CONFIG, DATA_ATTRIBUTES } from '../config/galleryConfig';

// Gallery configuration
const categories: CategoryConfig[] = [
  { id: 'arte', label: 'Arte', items: arteGallery },
  { id: 'musica', label: 'Música', items: musicaGallery },
  { id: 'fotografia', label: 'Fotografía', items: fotografiaGallery },
];

const totalImages = arteGallery.length;
const visibleImages = GALLERY_CONFIG.VISIBLE_IMAGES;
---

<section
  id="galeria"
  class="lg:-8 relative flex h-[80dvh] w-full items-center justify-center overflow-hidden bg-gray-950 px-4 text-left text-black sm:px-9"
>
  <!-- Ensure shared animation variables are loaded so JS can read them -->
  <link rel="stylesheet" href="/src/styles/animations.css" />

  <!-- Category buttons -->
  <div
    class="absolute top-0 left-0 z-20 flex gap-4 p-4 sm:p-8"
    data-category-buttons
  >
    {
      categories.map((category, index) => (
        <CategoryButton
          category={category.id}
          label={category.label}
          isActive={index === 0}
        />
      ))
    }
  </div>

  <!-- Gallery container -->
  <div
    class="relative mx-auto my-8 flex w-[1140px] items-center justify-between"
  >
    <!-- Previous button -->
    <NavigationButton
      id="prevBtn"
      direction="prev"
      ariaLabel="Previous gallery page"
    />

    <!-- Gallery slider -->
    <div
      class="gallery-container relative mx-auto overflow-hidden"
      style="width: 1140px;"
    >
      <div class="w-full overflow-hidden">
        <div
          id="imageSlider"
          class="flex transition-transform duration-800 ease-in-out"
          style="min-width: max-content;"
        >
          <!-- Arte items -->
          {arteGallery.map((item) => <GalleryItem item={item} />)}

          <!-- Música items -->
          {musicaGallery.map((item) => <MusicCard item={item} />)}

          <!-- Fotografía items -->
          {fotografiaGallery.map((item) => <FotografiaCard item={item} />)}
        </div>
      </div>
    </div>

    <!-- Next button -->
    <NavigationButton
      id="nextBtn"
      direction="next"
      ariaLabel="Next gallery page"
    />
  </div>

  <script type="module" define:vars={{ totalImages, visibleImages }}>
    import { createGallerySlider } from '/src/composables/useGallerySlider.ts';
    import { createCategorySwitch } from '/src/composables/useCategorySwitch.ts';
    import { initializeMusicPlayers } from '/src/utils/musicPlayer.ts';

    document.addEventListener('DOMContentLoaded', () => {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const slider = document.getElementById('imageSlider');
      const buttonsContainer = document.querySelector(
        '[data-category-buttons]',
      );

      if (!prevBtn || !nextBtn || !slider || !buttonsContainer) {
        console.error('Gallery: Required elements not found');
        return;
      }

      // Initialize slider
      const gallerySlider = createGallerySlider(
        slider,
        prevBtn,
        nextBtn,
        totalImages,
      );

      const cleanupSlider = gallerySlider.initialize();

      // Initialize category switching
      const categorySwitch = createCategorySwitch(
        buttonsContainer,
        gallerySlider.resetSlider,
        {
          onCategoryChange: (category) => {
            console.log('Category changed to:', category);
            // Re-initialize music players when switching to musica
            if (category === 'musica') {
              setTimeout(initializeMusicPlayers, 100);
            }
          },
        },
      );

      const cleanupCategory = categorySwitch.initialize('arte');

      // Initialize music players
      initializeMusicPlayers();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        cleanupSlider();
        cleanupCategory();
      });
    });
  </script>

  <style>
    .gallery-container::before,
    .gallery-container::after {
      display: none !important;
    }

    .w-full.overflow-x-auto {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .w-full.overflow-x-auto::-webkit-scrollbar {
      display: none;
    }

    .gallery-container {
      box-sizing: content-box;
      padding: 0;
    }

    #imageSlider {
      transition: transform var(--card-transition-duration) ease-in-out;
    }
  </style>
</section>
