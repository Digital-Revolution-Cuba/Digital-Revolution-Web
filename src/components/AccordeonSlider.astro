---
import { accordeonConfig } from "../config/accordeonConfig";
import { accordeonCards } from "../data/accordeonData";
import type { AccordeonCard, AccordeonPage } from "../types/accordeon.types";

/**
 * AccordeonSlider.astro
 *
 * Displays a paginated accordion of rhombus-shaped talent cards.
 * - Each dot navigates to a page of `cardsPerPage` cards.
 * - Each card has its own unique image (configured in accordeonData.ts).
 * - Animation is handled by the client-side initializer.
 *
 * To change card images: edit `src/data/accordeonData.ts`
 * To change animation/pagination config: edit `src/config/accordeonConfig.ts`
 */

interface Props {
  /** Override default cards (useful for testing or dynamic content) */
  cards?: readonly AccordeonCard[];
}

const { cards = accordeonCards } = Astro.props;
const { cardsPerPage } = accordeonConfig;

// Build pages: group cards into chunks of `cardsPerPage`
const pages: AccordeonPage[] = [];
for (let i = 0; i < cards.length; i += cardsPerPage) {
  pages.push({
    index: pages.length,
    cards: cards.slice(i, i + cardsPerPage),
  });
}

const totalPages = pages.length;

// Card layout helpers — position 0, 1, 2 within each page
const CARD_WIDTHS = ["15.5rem", "12.5rem", "13.75rem"] as const;
const CARD_HEIGHT = "21.25rem";

function isEvenPosition(positionInPage: number): boolean {
  return positionInPage % 2 === 0;
}
---

<div class="acordeon-wrapper" data-cards-per-page={cardsPerPage} data-total-pages={totalPages}>
  <div class="acordeon-container" id="acordeonSlider">
    {
      pages.map((page, pageIndex) => (
        <div
          class={`acordeon-page ${pageIndex === 0 ? "active" : ""}`}
          data-page-index={pageIndex}
          aria-hidden={pageIndex !== 0 ? "true" : undefined}
        >
          {page.cards.map((card, posInPage) => {
            const even = isEvenPosition(posInPage);
            const globalIndex = pageIndex * cardsPerPage + posInPage;
            return (
              <div
                class={`acordeon-item group relative transform cursor-pointer transition-all duration-500 ${
                  even
                    ? "origin-left -translate-y-7 skew-y-18 hover:translate-y-14 hover:-skew-y-18"
                    : "origin-right -skew-y-25 hover:translate-y-24 hover:skew-y-25"
                } hover:z-50 hover:rotate-y-0 hover:rotate-z-0`}
                style={`height: ${CARD_HEIGHT}; width: ${CARD_WIDTHS[posInPage] ?? CARD_WIDTHS[2]};`}
                data-slide-index={globalIndex}
                data-pos-in-page={posInPage}
              >
                <div
                  class={`flip-inner relative h-full w-full transition-transform duration-700 ${
                    even ? "group-hover:-rotate-y-180" : "group-hover:rotate-y-180"
                  }`}
                >
                  {/* Front face — unique image */}
                  <div class="flip-front absolute inset-0 h-full w-full backface-hidden">
                    <img
                      src={card.image}
                      alt={card.alt}
                      width="248"
                      height="340"
                      loading={pageIndex === 0 ? "eager" : "lazy"}
                      decoding="async"
                      class={`h-full w-full border border-white/30 object-cover shadow-2xl ${
                        even
                          ? "rounded-4xl rounded-tr-2xl rounded-bl-2xl"
                          : "rounded-4xl rounded-tl-2xl rounded-br-2xl"
                      }`}
                    />
                  </div>

                  {/* Back face — text label */}
                  <div
                    class={`flip-back bg-brand-navy font-roboto absolute inset-0 flex h-full w-full rotate-y-180 items-center justify-center border border-white/30 px-2 text-center shadow-2xl backface-hidden ${
                      even
                        ? "rounded-4xl rounded-tr-2xl rounded-bl-2xl"
                        : "rounded-4xl rounded-tl-2xl rounded-br-2xl"
                    }`}
                  >
                    <span class="text-xl font-bold text-white">{card.backText}</span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      ))
    }
  </div>

  {/* Navigation Dots — one per page, not per card */}
  <nav class="acordeon-dots" id="acordeonDots" aria-label="Navegación de acordeón">
    {
      pages.map((page, pageIndex) => (
        <button
          class={`acordeon-dot ${pageIndex === 0 ? "active" : ""}`}
          data-page-index={pageIndex}
          type="button"
          aria-label={`Ver página ${pageIndex + 1} de ${totalPages}`}
          aria-current={pageIndex === 0 ? "true" : undefined}
        />
      ))
    }
  </nav>
</div>

<style>
  /* ─── Layout ─── */
  .acordeon-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .acordeon-container {
    perspective: 1000px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    /* Reserve space so layout doesn't jump between pages */
    min-height: 22rem;
  }

  /* ─── Page groups ─── */
  .acordeon-page {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    position: absolute;
    opacity: 0;
    pointer-events: none;
    transition: none;
  }

  .acordeon-page.active {
    position: relative;
    opacity: 1;
    pointer-events: auto;
  }

  /* ─── Card items ─── */
  .acordeon-item {
    transform-style: preserve-3d;
  }

  .flip-inner {
    transform-style: preserve-3d;
  }

  .backface-hidden {
    backface-visibility: hidden;
  }

  .rotate-y-180 {
    transform: rotateY(180deg);
  }

  .group:hover .group-hover\:rotate-y-180 {
    transform: rotateY(180deg);
  }

  /* ─── Dots navigation ─── */
  .acordeon-dots {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 3rem;
  }

  .acordeon-dot {
    position: relative;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  /* 44×44 px touch target (WCAG best practice) */
  .acordeon-dot::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 22px;
    height: 22px;
    border-radius: 50%;
  }

  .acordeon-dot:hover {
    background: rgba(255, 255, 255, 0.6);
    transform: scale(1.2);
  }

  .acordeon-dot.active {
    background: var(--palette-accent-orange, #f49624);
    transform: scale(1.3);
  }

  /* ─── Mobile flip (touch devices) ─── */
  @media (hover: none) and (pointer: coarse) {
    .acordeon-item.mobile-flipped .flip-inner {
      transform: rotateY(180deg) !important;
    }

    /* Even-positioned cards flip the opposite direction */
    .acordeon-item.mobile-flipped[data-pos-in-page="0"] .flip-inner,
    .acordeon-item.mobile-flipped[data-pos-in-page="2"] .flip-inner {
      transform: rotateY(-180deg) !important;
    }

    .acordeon-item.mobile-flipped[data-pos-in-page="1"] .flip-inner {
      transform: rotateY(180deg) !important;
    }
  }

  /* ─── Page transition: smooth fade-slide ─── */
  .acordeon-page.page-exit {
    animation: pageFadeOut 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .acordeon-page.page-enter {
    animation: pageFadeIn 0.4s cubic-bezier(0, 0, 0.2, 1) forwards;
  }

  @keyframes pageFadeOut {
    0% {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateX(-30px) scale(0.97);
    }
  }

  @keyframes pageFadeIn {
    0% {
      opacity: 0;
      transform: translateX(30px) scale(0.97);
    }
    100% {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  /* Staggered card entrance within a page */
  .acordeon-page.page-enter .acordeon-item {
    animation: cardReveal 0.4s cubic-bezier(0, 0, 0.2, 1) both;
  }

  .acordeon-page.page-enter .acordeon-item:nth-child(1) {
    animation-delay: 0ms;
  }
  .acordeon-page.page-enter .acordeon-item:nth-child(2) {
    animation-delay: 60ms;
  }
  .acordeon-page.page-enter .acordeon-item:nth-child(3) {
    animation-delay: 120ms;
  }

  @keyframes cardReveal {
    0% {
      opacity: 0;
      transform: translateY(12px) scale(0.95);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* ─── Responsive ─── */
  @media (max-width: 768px) {
    .acordeon-container {
      transform: scale(0.7);
      transform-origin: center;
    }

    .acordeon-dots {
      margin-top: 2rem;
    }
  }

  @media (max-width: 480px) {
    .acordeon-container {
      transform: scale(0.55);
    }
  }
</style>
