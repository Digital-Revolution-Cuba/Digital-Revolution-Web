name: ğŸ“‹ Auto-Create Issues

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/auto-issue/issues.json'

permissions:
  issues: write
  contents: read

jobs:
  create-issues:
    name: ğŸ¯ Create Issues from JSON
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“‹ Create issues from JSON
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Leer el archivo JSON
            const issuesPath = path.join(process.env.GITHUB_WORKSPACE, '.github/auto-issue/issues.json');
            const issuesData = JSON.parse(fs.readFileSync(issuesPath, 'utf8'));
            
            console.log(`ğŸ“Š Found ${issuesData.length} issues to create`);
            
            // Obtener issues existentes para evitar duplicados
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            const existingTitles = new Set(existingIssues.data.map(issue => issue.title));
            
            let created = 0;
            let skipped = 0;
            
            for (const issue of issuesData) {
              // Verificar si el issue ya existe
              if (existingTitles.has(issue.title)) {
                console.log(`â­ï¸  Skipping existing issue: ${issue.title}`);
                skipped++;
                continue;
              }
              
              try {
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issue.title,
                  body: issue.body,
                  labels: issue.labels || []
                });
                
                console.log(`âœ… Created issue #${newIssue.data.number}: ${issue.title}`);
                created++;
                
                // PequeÃ±o delay para evitar rate limiting
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.error(`âŒ Error creating issue "${issue.title}":`, error.message);
              }
            }
            
            console.log(`\nğŸ“ˆ Summary:`);
            console.log(`   âœ… Created: ${created}`);
            console.log(`   â­ï¸  Skipped: ${skipped}`);
            console.log(`   ğŸ“Š Total: ${issuesData.length}`);
            
            // Crear un comentario en el commit con el resumen
            if (context.eventName === 'push') {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `## ğŸ“‹ Issues Auto-Creation Summary\n\n- âœ… Created: ${created}\n- â­ï¸ Skipped (duplicates): ${skipped}\n- ğŸ“Š Total processed: ${issuesData.length}`
              });
            }
