name: Bundle Size â€” Analysis

on:
  pull_request:
    branches: [main, develop]
    # Only run when source files change, not docs/config
    paths:
      - 'src/**'
      - 'public/**'
      - 'astro.config.mjs'
      - 'package.json'
      - 'pnpm-lock.yaml'

concurrency:
  group: bundle-size-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get pnpm store directory
        id: pnpm-store
        shell: bash
        run: echo "dir=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.dir }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build PR branch
        run: pnpm build

      - name: Measure PR bundle size
        id: pr-size
        shell: bash
        run: |
          total=$(du -sb dist/ | cut -f1)
          total_kb=$((total / 1024))
          echo "bytes=$total" >> "$GITHUB_OUTPUT"
          echo "kb=$total_kb" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ PR dist size: ${total_kb} KB"

      - name: Measure JS assets
        id: js-size
        shell: bash
        run: |
          if ls dist/_astro/*.js 1>/dev/null 2>&1; then
            js=$(du -sb dist/_astro/*.js | awk '{s+=$1} END {print s}')
            echo "bytes=$js" >> "$GITHUB_OUTPUT"
            echo "kb=$((js / 1024))" >> "$GITHUB_OUTPUT"
          else
            echo "bytes=0" >> "$GITHUB_OUTPUT"
            echo "kb=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Measure CSS assets
        id: css-size
        shell: bash
        run: |
          if ls dist/_astro/*.css 1>/dev/null 2>&1; then
            css=$(du -sb dist/_astro/*.css | awk '{s+=$1} END {print s}')
            echo "bytes=$css" >> "$GITHUB_OUTPUT"
            echo "kb=$((css / 1024))" >> "$GITHUB_OUTPUT"
          else
            echo "bytes=0" >> "$GITHUB_OUTPUT"
            echo "kb=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment bundle stats on PR
        uses: actions/github-script@v8
        with:
          script: |
            const totalKb = '${{ steps.pr-size.outputs.kb }}';
            const jsKb    = '${{ steps.js-size.outputs.kb }}';
            const cssKb   = '${{ steps.css-size.outputs.kb }}';
            const sha     = context.sha.slice(0, 7);

            // Colour-code based on total size thresholds
            const sizeIcon = Number(totalKb) > 5000 ? 'ðŸ”´' :
                             Number(totalKb) > 2000 ? 'ðŸŸ¡' : 'ðŸŸ¢';

            const body = [
              '## ðŸ“¦ Bundle Size Report',
              '',
              `| Asset      | Size |`,
              `|------------|------|`,
              `| **Total dist** | ${sizeIcon} **${totalKb} KB** |`,
              `| JS (\_astro)   | ðŸŸ¦ ${jsKb} KB |`,
              `| CSS (\_astro)  | ðŸŸª ${cssKb} KB |`,
              '',
              `> Commit: \`${sha}\` â€” sizes measured after \`astro build\``,
              '> ðŸŸ¢ <2 MB Â· ðŸŸ¡ 2-5 MB Â· ðŸ”´ >5 MB',
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(
              (c) => c.user.type === 'Bot' && c.body.includes('Bundle Size Report')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
