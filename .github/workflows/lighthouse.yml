name: Lighthouse — Performance Audit

on:
  # Run after every successful production deploy
  repository_dispatch:
    types:
      - 'vercel.deployment.success'
  # Also allow manual runs
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to audit (defaults to production)'
        required: false
        default: ''

concurrency:
  group: lighthouse-${{ github.sha }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine URL to audit
        id: url
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "target=${{ github.event.client_payload.url }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.inputs.url }}" ]; then
            echo "target=${{ github.event.inputs.url }}" >> "$GITHUB_OUTPUT"
          else
            echo "target=https://digital-revolution-web.vercel.app" >> "$GITHUB_OUTPUT"
          fi

      # ── Core pages to audit ──────────────────────────────────────────────
      - name: Run Lighthouse — Home
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.url.outputs.target }}/
            ${{ steps.url.outputs.target }}/galeria
            ${{ steps.url.outputs.target }}/concursos
            ${{ steps.url.outputs.target }}/talentos
            ${{ steps.url.outputs.target }}/colaboraciones
          budgetPath: .github/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 1

      - name: Assert Lighthouse thresholds
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ steps.url.outputs.target }}/
          runs: 1
          uploadArtifacts: false
          # Minimum scores required — fail CI if below
          # Performance: ≥70, Accessibility: ≥90, Best Practices: ≥90, SEO: ≥90
